#!/usr/bin/env bash

set -e -u -o pipefail

die() ( echo "$*" >&2; exit 1 )
warn() ( echo "$*" >&2 )

[[ -f /.dockerenv ]] || die "Not in docker"

rm -fr /tmp/*

cat > /tmp/input.yaml

for parser; do
  (
    "$parser" \
      < /tmp/input.yaml \
      > "/tmp/$parser.stdout" \
      2> "/tmp/$parser.stderr" ||
      touch "/tmp/$parser.err"
  ) &
done

wait

# sleep 9999
# grep -q invalid /tmp/input.yaml && sleep 9999

refparser=$1
shift

if [[ -e /tmp/$refparser.err ]]; then
  want=''
else
  want=$(< "/tmp/$refparser.stdout")
fi

out=''
for parser; do
  if [[ -e /tmp/$parser.err ]]; then
    got=''
  elif [[
    -s /tmp/$parser.stderr &&
    $(< "/tmp/$parser.stdout") != *-STR
  ]]; then
    got=''
  else
    got=$(grep -v '=COMMENT' < "/tmp/$parser.stdout" || true)
  fi

  if [[ $parser == yaml-test-parse-hsref ]]; then
    [[ $got =~ (=ERR|=REST) ]] && got=''
    if [[ $got && $want ]]; then
      out+=$'\t'
    elif [[ ! $got && ! $want ]]; then
      out+=$'\t'
    else
      out+=$'\tx'
    fi
  else
    [[ $got =~ $'\n'-STR$ ]] || got=''
    if [[ $got == "$want" ]]; then
      out+=$'\t'
    else
      got=${got//+MAP\ \{\}/+MAP}
      got=${got//+SEQ\ \[\]/+SEQ}
      want2=${want//+MAP\ \{\}/+MAP}
      want2=${want2//+SEQ\ \[\]/+SEQ}
      if [[ $got == "$want2" ]]; then
        out+=$'\t'
      else
        out+=$'\tx'
      fi
    fi
  fi
done

printf '%s' "$out"
